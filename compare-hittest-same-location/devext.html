<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=Edge" />
		<meta
			name="viewport"
			content="initial-scale=1,maximum-scale=1,user-scalable=no"
		/>
		<title>Popup feature order devext</title>
		<style>
			html,
			body,
			#viewDiv {
				padding: 0;
				margin: 0;
				height: 100%;
				width: 100%;
			}
			.title {
				position: absolute;
				top: 1em;
				right: 1em;
				margin: 0;
				background: #ffffff;
				padding: 5px;
			}
		</style>

		<link
			rel="stylesheet"
			href="https://jsdev.arcgis.com/4.28/esri/themes/light/main.css"
		/>
		<script src="https://jsdev.arcgis.com/4.29/"></script>

		<script>
			require(["esri/Map", "esri/views/MapView", "esri/WebMap"], (
				Map,
				MapView,
				WebMap
			) =>
				(async () => {
					// Function to create a webmap from the URL parameters.
					async function createWebmap() {
						let { id, portal, url } = getUrlParams();

						if (!url) {
							if (!id) {
								id = "ec5edbd9ddb54fecab0086030600b319";
							}

							if (!portal) {
								portal = "https://www.arcgis.com/";
							}

							setUrlParams(id, portal);
							//esriConfig.portal = portal;
						} else {
							portal = null;
							id = null;
						}
						return new WebMap({
							portalItem: {
								id: id,
								portal: portal,
							},
						});
					}

					const webmap = await createWebmap();

					const view = new MapView({
						container: "viewDiv",
						map: webmap,
						popup: {
							defaultPopupTemplateEnabled: true,
						},
						popupEnabled: false,
					});

					view.on("click", (event) => {
						window.parent.postMessage(
							{
								type: "hit-location",
								screenPoint: { x: event.x, y: event.y },
							},
							"*"
						);
					});

					const messageHandler = (ev) => {
						switch (ev?.data?.type) {
							case "hit-location":
								const mapPoint = view.toMap(ev?.data?.screenPoint);
								view.openPopup({
									location: mapPoint,
									fetchFeatures: true,
								});
								ev.stopPropagation();
								break;
						}
					};

					window.parent.addEventListener("message", messageHandler);

					view.addHandles({
						remove: () =>
							window.parent.removeEventListener("message", messageHandler),
					});

					// Get the URL parameters and parse them.
					function getUrlParams() {
						const queryParams = document.location.search.substr(1);
						let result = {};

						queryParams.split("&").forEach(function (part) {
							var item = part.split("=");
							result[item[0]] = decodeURIComponent(item[1]);
						});
						return result;
					}

					// Function to set an id as a URL param.
					function setUrlParams(id, portal) {
						window.history.pushState(
							"",
							"",
							`${window.location.pathname}?id=${id}&portal=${portal}`
						);
					}

					// //bind the window events
					// function bindEvent(element, eventName, eventHandler) {
					//   if (element.addEventListener) {
					//     element.addEventListener(eventName, eventHandler, false);
					//   } else if (element.attachEvent) {
					//     element.attachEvent('on' + eventName, eventHandler);
					//   }
					// }
				})());
		</script>
	</head>

	<body>
		<div id="viewDiv">
			<p class="title">4.29</p>
		</div>
	</body>
</html>
